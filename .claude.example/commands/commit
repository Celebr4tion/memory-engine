#!/bin/bash
# Custom command: /commit
# Description: Smart commit with testing and formatting

set -e

echo "ğŸ’¾ Memory Engine Smart Commit"
echo "============================="

# Check if virtual environment is activated
if [[ "$VIRTUAL_ENV" == "" ]]; then
    echo "âš ï¸  Activating virtual environment..."
    source .venv/bin/activate
fi

# Check git status
if git diff --quiet && git diff --cached --quiet; then
    echo "âŒ No changes to commit"
    exit 1
fi

# Show current changes
echo "ğŸ“‹ Current changes:"
git status --short

# Run quick tests on changed files
echo "ğŸ§ª Running quick tests..."
CHANGED_FILES=$(git diff --name-only --cached | grep -E "\.(py)$" || true)

if [[ -n "$CHANGED_FILES" ]]; then
    echo "ğŸ” Testing changed Python files..."
    for file in $CHANGED_FILES; do
        if [[ -f "$file" ]]; then
            echo "  - Checking $file..."
            python -m py_compile "$file" || {
                echo "âŒ Syntax error in $file"
                exit 1
            }
        fi
    done
    
    # Run relevant tests
    echo "ğŸƒ Running relevant tests..."
    python -m pytest tests/ -v --tb=short -x -k "not Integration" || {
        echo "âŒ Tests failed. Fix issues before committing."
        exit 1
    }
fi

# Get commit message
if [[ $# -eq 0 ]]; then
    echo "ğŸ“ Enter commit message:"
    read -r COMMIT_MSG
else
    COMMIT_MSG="$*"
fi

# Add standard footer
COMMIT_MSG_WITH_FOOTER="$COMMIT_MSG

ğŸ¤– Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>"

# Commit changes
echo "ğŸ’¾ Committing changes..."
git commit -m "$COMMIT_MSG_WITH_FOOTER"

echo "âœ… Commit successful!"
echo "ğŸ“Š Recent commits:"
git log --oneline -5